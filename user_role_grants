-- virtual warehouses: etl, query
USE ROLE SYSADMIN;

CREATE WAREHOUSE ETL
WITH
    WAREHOUSE_SIZE = 'XSMALL'
    AUTO_SUSPEND = 60
    AUTO_RESUME = TRUE
    COMMENT = 'A computing resource for dbt to run ETL';

CREATE WAREHOUSE QUERY
WITH
    WAREHOUSE_SIZE = 'XSMALL'
    AUTO_SUSPEND = 60
    AUTO_RESUME = TRUE
    COMMENT = 'A computing resource for querying data';

-- databases and schemas
CREATE DATABASE IF NOT EXISTS NORTHWIND;
CREATE SCHEMA IF NOT EXISTS NORTHWIND.RAW;
CREATE SCHEMA IF NOT EXISTS NORTHWIND.STAGING;
CREATE SCHEMA IF NOT EXISTS NORTHWIND.CURATED;
CREATE SCHEMA IF NOT EXISTS NORTHWIND.UTIL;

-- roles and users
USE ROLE USERADMIN;

CREATE ROLE IF NOT EXISTS DBT_RW;
CREATE USER IF NOT EXISTS dbt
    PASSWORD='ddbt'
    LOGIN_NAME='dbt'
    MUST_CHANGE_PASSWORD=FALSE
    DEFAULT_WAREHOUSE='ETL'
    DEFAULT_ROLE='DBT_RW'
    DEFAULT_NAMESPACE='NORTHWIND.RAW'
    COMMENT='A dbt user used for ETL';

CREATE ROLE IF NOT EXISTS NORTHWIND_RW;
CREATE USER IF NOT EXISTS Test_NORTHWIND
    PASSWORD='password'
    LOGIN_NAME='Test_NORTHWIND'
    MUST_CHANGE_PASSWORD=FALSE
    DEFAULT_WAREHOUSE='QUERY'
    DEFAULT_ROLE='NORTHWIND_RW'
    DEFAULT_NAMESPACE='NORTHWIND.RAW'
    COMMENT='NORTHWIND test';


USE ROLE SECURITYADMIN;

GRANT ROLE DBT_RW TO USER dbt;
GRANT ROLE NORTHWIND_RW TO USER Test_NORTHWIND;

-- set up permissions
USE ROLE SECURITYADMIN;

-- dbt_rw account level
GRANT USAGE ON WAREHOUSE ETL TO ROLE DBT_RW;
GRANT USAGE ON WAREHOUSE QUERY TO ROLE DBT_RW;
GRANT ALL ON DATABASE NORTHWIND TO ROLE DBT_RW;
-- dbt_rw schema level
GRANT ALL ON ALL SCHEMAS IN DATABASE NORTHWIND TO ROLE DBT_RW;
GRANT ALL ON FUTURE SCHEMAS IN DATABASE NORTHWIND TO ROLE DBT_RW;
-- dbt_rw object level
GRANT ALL ON ALL TABLES IN SCHEMA NORTHWIND.RAW TO ROLE DBT_RW;
GRANT ALL ON FUTURE TABLES IN SCHEMA NORTHWIND.RAW TO ROLE DBT_RW;
GRANT ALL ON ALL TABLES IN SCHEMA NORTHWIND.STAGING TO ROLE DBT_RW;
GRANT ALL ON FUTURE TABLES IN SCHEMA NORTHWIND.STAGING TO ROLE DBT_RW;
GRANT ALL ON ALL VIEWS IN SCHEMA NORTHWIND.CURATED TO ROLE DBT_RW;
GRANT ALL ON FUTURE VIEWS IN SCHEMA NORTHWIND.CURATED TO ROLE DBT_RW;

-- NORTHWIND_rw account level
GRANT USAGE ON WAREHOUSE ETL TO ROLE NORTHWIND_RW;
GRANT USAGE ON WAREHOUSE QUERY TO ROLE NORTHWIND_RW;
GRANT ALL ON DATABASE NORTHWIND TO ROLE NORTHWIND_RW;
-- NORTHWIND_rw schema level
GRANT ALL ON ALL SCHEMAS IN DATABASE NORTHWIND TO ROLE NORTHWIND_RW;
GRANT ALL ON FUTURE SCHEMAS IN DATABASE NORTHWIND TO ROLE NORTHWIND_RW;
-- NORTHWIND_rw object level
GRANT ALL ON ALL TABLES IN SCHEMA NORTHWIND.RAW TO ROLE NORTHWIND_RW;
GRANT ALL ON FUTURE TABLES IN SCHEMA NORTHWIND.RAW TO ROLE NORTHWIND_RW;
GRANT ALL ON ALL TABLES IN SCHEMA NORTHWIND.STAGING TO ROLE NORTHWIND_RW;
GRANT ALL ON FUTURE TABLES IN SCHEMA NORTHWIND.STAGING TO ROLE NORTHWIND_RW;
GRANT ALL ON ALL VIEWS IN SCHEMA NORTHWIND.CURATED TO ROLE NORTHWIND_RW;
GRANT ALL ON FUTURE VIEWS IN SCHEMA NORTHWIND.CURATED TO ROLE NORTHWIND_RW;
